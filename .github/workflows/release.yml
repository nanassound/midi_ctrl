name: Build Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir and Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          elixir-version: '1.19.0'

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install dependencies
        run: mix deps.get

      - name: Build release
        run: MIX_ENV=prod mix release

      - name: Create tarball
        run: tar -czf midi_ctrl-macos.tar.gz -C _build/prod/rel/midi_ctrl .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: midi_ctrl-macos
          path: midi_ctrl-macos.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir and Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          elixir-version: '1.19.0'

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev

      - name: Install dependencies
        run: mix deps.get

      - name: Build release
        run: MIX_ENV=prod mix release

      - name: Create tarball
        run: tar -czf midi_ctrl-linux.tar.gz -C _build/prod/rel/midi_ctrl .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: midi_ctrl-linux
          path: midi_ctrl-linux.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir and Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          elixir-version: '1.19.0'

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install dependencies
        run: mix deps.get

      - name: Build release
        run: |
          $env:MIX_ENV="prod"
          mix release

      - name: Create zip archive
        run: Compress-Archive -Path _build/prod/rel/midi_ctrl/* -DestinationPath midi_ctrl-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: midi_ctrl-windows
          path: midi_ctrl-windows.zip

  create-release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            midi_ctrl-macos/midi_ctrl-macos.tar.gz
            midi_ctrl-linux/midi_ctrl-linux.tar.gz
            midi_ctrl-windows/midi_ctrl-windows.zip
          body: |
            ## MIDICtrl Release

            Control MIDI devices with Claude AI through natural language.

            ### Installation

            Download the appropriate release for your platform:
            - **macOS**: `midi_ctrl-macos.tar.gz`
            - **Linux**: `midi_ctrl-linux.tar.gz`
            - **Windows**: `midi_ctrl-windows.zip`

            Extract and run:
            ```bash
            # macOS/Linux
            tar -xzf midi_ctrl-*.tar.gz
            cd midi_ctrl
            ./bin/midi_ctrl start

            # Windows
            # Extract midi_ctrl-windows.zip
            # Run bin\midi_ctrl.bat start
            ```

            ### Configuration

            Add to your Claude Desktop config:
            ```json
            {
              "mcpServers": {
                "midi_ctrl": {
                  "command": "npx",
                  "args": ["-y", "mcp-remote", "http://localhost:3000/mcp"]
                }
              }
            }
            ```

            See the [README](https://github.com/${{ github.repository }}) for full documentation.
          draft: false
          prerelease: false
